name: Run tests

on:
  pull_request:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Start Firefly III test server
        run: |
          cd test/fireflyServer
          docker compose up -d

      - name: Show Firefly startup logs
        run: |
          sleep 10
          docker compose -f test/fireflyServer/docker-compose.yml logs --tail=50

      - name: Install requests for health check
        run: pip install requests

      - name: Wait for Firefly III to be ready
        run: |
          python3 << 'EOF'
          import requests
          import time
          import sys

          max_attempts = 120  # 2 minutes timeout
          for attempt in range(max_attempts):
              try:
                  response = requests.get('http://127.0.0.1/login', timeout=5)
                  if response.status_code == 200:
                      print(f"✓ Firefly III is ready! (attempt {attempt+1})")
                      sys.exit(0)
              except requests.exceptions.RequestException:
                  if attempt % 10 == 0:
                      print(f"Waiting for Firefly III... ({attempt+1}/{max_attempts})")
              time.sleep(1)

          print("✗ Firefly III failed to start after 2 minutes")
          sys.exit(1)
          EOF

      - name: Install package with dev dependencies
        run: pip install -e ".[dev]"

      - name: Setup Laravel Passport for Firefly III
        run: |
          # Initialize Passport keys and personal access client
          docker exec firefly_iii_core php artisan passport:keys --force
          docker exec firefly_iii_core php artisan passport:client --personal --name="Test Client" --no-interaction

      - name: Create Firefly III user and API token via CLI
        run: |
          # Create user via Firefly III's built-in user creation, then add token via PHP
          echo "Creating user via Firefly III..."

          # Use Firefly's user create command (if available) or create via database
          cat << 'EOFPHP' | docker exec -i firefly_iii_core php > /tmp/token_output.txt 2>&1
          <?php
          require __DIR__ . '/vendor/autoload.php';
          $app = require_once __DIR__ . '/bootstrap/app.php';
          $kernel = $app->make(Illuminate\Contracts\Console\Kernel::class);
          $kernel->bootstrap();

          use FireflyIII\User;
          use FireflyIII\Models\UserGroup;
          use FireflyIII\Models\GroupMembership;
          use Illuminate\Support\Facades\Hash;

          try {
              $email = 'test@example.com';
              $password = 'password123';

              $user = User::where('email', $email)->first();
              if (!$user) {
                  // Create user group first
                  $group = new UserGroup();
                  $group->title = 'Test User Group';
                  $group->save();

                  // Create user
                  $user = new User();
                  $user->email = $email;
                  $user->password = Hash::make($password);
                  $user->blocked = false;
                  $user->blocked_code = null;
                  $user->user_group_id = $group->id;
                  $user->save();

                  // Create group membership with owner role
                  $membership = new GroupMembership();
                  $membership->user_id = $user->id;
                  $membership->user_group_id = $group->id;
                  $membership->user_role_id = 21; // 21 = owner role (full permissions including purge)
                  $membership->save();
              }

              $token = $user->createToken('Test Token');
              echo "TOKEN=" . $token->accessToken . "\n";
          } catch (Exception $e) {
              echo "ERROR: " . $e->getMessage() . "\n";
              exit(1);
          }
          EOFPHP

          # Extract token and save to environment variable for tests
          echo "=== PHP Script Output ==="
          cat /tmp/token_output.txt || echo "File not found or empty"
          echo "=== End Output ==="
          TOKEN=$(grep "^TOKEN=" /tmp/token_output.txt 2>/dev/null | cut -d= -f2 | tr -d '\n\r ')
          if [ -z "$TOKEN" ]; then
              echo "❌ Failed to create token - no TOKEN= line found"
              exit 1
          fi
          echo "TEST_API_TOKEN=$TOKEN" >> $GITHUB_ENV
          echo "✓ Token created successfully"

      - name: Run tests
        run: pytest --cov=fireflyConverter test/ --cov-report=html --cov-report=term

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: htmlcov/
          retention-days: 30

      - name: Cleanup
        if: always()
        run: |
          cd test/fireflyServer
          docker compose down -v
