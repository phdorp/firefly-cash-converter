name: Run tests

on:
  pull_request:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Start Firefly III test server
        run: |
          cd test/fireflyServer
          docker compose up -d

      - name: Show Firefly startup logs
        run: |
          sleep 10
          docker compose -f test/fireflyServer/docker-compose.yml logs --tail=50

      - name: Install requests for health check
        run: pip install requests

      - name: Wait for Firefly III to be ready
        run: |
          python3 << 'EOF'
          import requests
          import time
          import sys
          import subprocess
          import re

          max_attempts = 600  # 10 minutes timeout
          for attempt in range(max_attempts):
              try:
                  response = requests.get('http://localhost/login', timeout=10)
                  print(f"Attempt {attempt+1}: Status {response.status_code}, Length {len(response.text)}")

                  # Check if we have a valid login page with CSRF token
                  if response.status_code == 200:
                      has_csrf = '_token' in response.text or 'csrf-token' in response.text
                      has_login = 'login' in response.text.lower()

                      if has_csrf and has_login:
                          # Found login page, now verify the app is fully initialized
                          # by checking if we can access other pages
                          try:
                              profile_resp = requests.get('http://localhost/profile', timeout=10, allow_redirects=True)
                              # If we get redirected back to login, app is ready but we're not logged in (expected)
                              # If we get a 500 error, the app might still be initializing
                              if profile_resp.status_code != 500:
                                  print("✓ Firefly III is ready!")
                                  sys.exit(0)
                          except:
                              # Profile check failed, but app is responding
                              if attempt > 120:  # After 2 minutes, assume we're ready
                                  print("✓ Firefly III app responding (assuming ready)")
                                  sys.exit(0)

              except requests.exceptions.ConnectionError as e:
                  if attempt % 30 == 0:
                      print(f"Attempt {attempt+1}: Connection refused (app not ready yet)")
              except requests.exceptions.Timeout as e:
                  if attempt % 30 == 0:
                      print(f"Attempt {attempt+1}: Timeout (app not responding)")
              except requests.exceptions.RequestException as e:
                  if attempt % 30 == 0:
                      print(f"Attempt {attempt+1}: {type(e).__name__}")

              if attempt % 60 == 0 and attempt > 0:
                  print(f"Still waiting... ({attempt}/{max_attempts})")
                  # Show logs every minute
                  subprocess.run(['docker', 'compose', '-f', 'test/fireflyServer/docker-compose.yml', 'logs', '--tail=20'],
                                cwd='.')
              time.sleep(1)

          print("✗ Firefly III failed to start after 10 minutes")
          print("\nFinal Docker logs:")
          subprocess.run(['docker', 'compose', '-f', 'test/fireflyServer/docker-compose.yml', 'logs'], cwd='.')
          sys.exit(1)
          EOF

      - name: Install package with dev dependencies
        run: pip install -e ".[dev]"

      - name: Setup Firefly API token
        run: |
          python test/fireflyServer/setupToken.py --save
        env:
          FIREFLY_URL: http://localhost
          FIREFLY_EMAIL: test@example.com
          FIREFLY_PASSWORD: password123

      - name: Run tests
        run: pytest --cov=fireflyConverter test/ --cov-report=html --cov-report=term

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: htmlcov/
          retention-days: 30

      - name: Cleanup
        if: always()
        run: |
          cd test/fireflyServer
          docker compose down -v
